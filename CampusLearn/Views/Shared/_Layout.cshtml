<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CampusLearn</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/CampusLearn.styles.css" asp-append-version="true" />

    <style>
        :root {
            --primary: #6a0dad;
            --primary-600: #5a0099;
            --muted: #6b7280;
            --nav-bg: rgba(255,255,255,0.7);
            --nav-blur: 8px;
            --nav-radius: 12px;
            --nav-shadow: 0 8px 30px rgba(16, 18, 38, 0.06);
            --content-offset: 1rem; /* controls horizontal offset from the page edge */
        }

        /* Modern navbar styling to match the app */
        .site-navbar {
            background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,252,0.85));
            backdrop-filter: blur(var(--nav-blur));
            -webkit-backdrop-filter: blur(var(--nav-blur));
            border-radius: var(--nav-radius);
            box-shadow: var(--nav-shadow);
            padding: 0.45rem 1rem;
            border: none;
            align-items: center;
            width: 100%;

            /* ensure navbar sits above page content */
            position: relative;
            z-index: 2200;
        }

        /*
          Make the .container-fluid a predictable flex container and keep brand/toggler order stable.
          Desktop-specific collapse/flex behaviour is applied in the min-width media query below to avoid
          interfering with Bootstrap's mobile collapse behavior.
        */
        .site-navbar > .container-fluid {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem;
            padding-left: var(--content-offset);
            padding-right: var(--content-offset);
        }

        /* Prevent the nav list from stretching across the whole bar but allow wrapping if needed */
        .site-navbar .navbar-nav {
            flex-grow: 0 !important;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: nowrap;
            min-width: 0; /* allow truncation/ellipsis if very small */
        }

        /* Brand */
        .navbar-brand {
            font-weight: 700;
            color: #111827 !important;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 0.5rem;
            order: 1;
            flex: 0 0 auto;
        }

        .navbar-brand::before {
            content: "";
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(106,13,173,0.14), rgba(90,0,153,0.06));
            box-shadow: 0 6px 16px rgba(106,13,173,0.06);
            display: inline-block;
        }

        /* Nav links as subtle pills */
        .navbar-nav .nav-link {
            color: #374151 !important;
            padding: 8px 12px;
            border-radius: 999px;
            margin: 0 6px;
            transition: transform 140ms ease, background-color 140ms ease, color 140ms ease, box-shadow 140ms ease;
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .navbar-nav .nav-link:hover {
            background: linear-gradient(90deg, rgba(106,13,173,0.06), rgba(106,13,173,0.03));
            color: var(--primary) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(106,13,173,0.06);
        }

        /* Active link */
        .navbar-nav .nav-link.active,
        .navbar-nav .nav-link[aria-current="page"] {
            background: linear-gradient(90deg, rgba(106,13,173,0.12), rgba(90,0,153,0.06));
            color: var(--primary) !important;
            box-shadow: 0 10px 26px rgba(106,13,173,0.08);
        }

        /* Ensure toggler sits to the right of the brand (order adjusted on desktop in media query) */
        .navbar-toggler {
            border: 1px solid rgba(16, 24, 40, 0.06);
            background: linear-gradient(180deg, #fff, #fafafa);
            border-radius: 8px;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .navbar-toggler svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        .navbar-toggler:focus {
            box-shadow: 0 6px 18px rgba(106,13,173,0.08);
        }

        /* Place the header region flush with the left side of the page */
        header {
            padding: 0.75rem var(--content-offset);
            display: flex;
            justify-content: flex-start;
            background: transparent;

            /* ensure header sits above page content too */
            position: relative;
            z-index: 2200;
        }

        /*
          Desktop behaviour: convert collapse to a flex item between brand and toggler so links are visible.
          This prevents mobile-only off-canvas rules from affecting desktop.
        */
        @@media (min-width: 577px) {
            .site-navbar .navbar-collapse {
                order: 2;
                display: flex !important;
                align-items: center;
                flex: 1 1 auto;            /* take available space on larger screens */
                min-width: 0;              /* prevent overflow from flex children */
                justify-content: flex-start !important;
            }

            /* Keep the toggler last so it's on the right on desktop */
            .site-navbar .navbar-toggler {
                order: 3;
                margin-left: 0;
                margin-inline-start: auto;
            }
        }

        /* Mobile-specific off-canvas panel (left) */
        @@media (max-width: 576px) {
            .site-navbar {
                padding: 0.35rem 0.7rem;
                border-radius: 10px;
            }

            .site-navbar > .container-fluid {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            /* Off-canvas left panel for the collapsed menu */
            .site-navbar .navbar-collapse {
                position: fixed;
                top: 0;
                left: 0;                        /* attach to left side */
                height: 100vh;
                width: 320px;
                max-width: 85%;
                background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,252,0.98));
                box-shadow: 18px 0 40px rgba(16, 18, 38, 0.12); /* shadow to the right */
                padding-top: 64px; /* space for the navbar/header area */
                transform: translateX(-110%);  /* hide off-screen to the left */
                transition: transform 320ms cubic-bezier(.2,.9,.2,1);
                z-index: 2300;                   /* panel above navbar/header and page content */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                border-right: 1px solid rgba(16,18,38,0.04);
                display: block; /* ensure default collapse behavior still works for Bootstrap JS */
            }

            /* When bootstrap adds .show, slide the panel in */
            .site-navbar .navbar-collapse.show {
                transform: translateX(0);
            }

            /* Backdrop that appears behind the panel */
            .mobile-backdrop {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(15,15,20,0.45);
                z-index: 2290; /* backdrop sits under panel but over page */
                transition: opacity 220ms ease;
                opacity: 0;
            }

            /* Show backdrop when panel is visible (collapse immediately before backdrop in DOM) */
            .site-navbar .navbar-collapse.show + .mobile-backdrop {
                display: block;
                opacity: 1;
            }

            /* Panel header with close button */
            .site-navbar .mobile-panel-header {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 64px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 14px;
                border-bottom: 1px solid rgba(16,18,38,0.04);
                background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(248,249,250,0.98));
                z-index: 2310;
                gap: 12px;
            }

            .mobile-panel-header .mobile-title {
                font-weight: 700;
                color: #111827;
                font-size: 1rem;
            }

            .mobile-panel-header .btn-close {
                border: none;
                background: transparent;
                width: 36px;
                height: 36px;
                padding: 0;
                opacity: 0.9;
            }

            /* Make nav links vertical inside the off-canvas panel */
            .site-navbar .navbar-nav {
                flex-direction: column;
                gap: 0;
                padding: 0.75rem 0.75rem;
                width: 100%;
            }

            .site-navbar .navbar-nav .nav-item {
                width: 100%;
            }

            .site-navbar .navbar-nav .nav-link {
                padding: 12px 14px;
                border-radius: 10px;
                margin: 6px 0;
                width: 100%;
                color: #374151 !important;
                background: transparent;
                font-size: 1rem;
            }

            .site-navbar .navbar-nav .nav-link:hover {
                transform: none;
                background: linear-gradient(90deg, rgba(106,13,173,0.04), rgba(106,13,173,0.02));
                color: var(--primary) !important;
            }

            .navbar-brand {
                font-size: 1rem;
            }

            /* ensure main content doesn't create its own stacking context above panel */
            main, footer, .container {
                position: relative;
                z-index: 0;
            }
        }

        /*
         Safety: ensure general page content is behind the header/nav stacking context.
         This avoids any page element (images/cards) from accidentally overlaying the navbar.
        */
        main, footer, .container {
            position: relative;
            z-index: 0;
        }
    </style>
</head>
<body>
    @{
        var hideHeader = ViewData["HideHeader"] as bool? ?? false;
    }
    @if (!hideHeader)
    {
        <header>
            <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light site-navbar mb-3">
                <div class="container-fluid">
                    <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">CampusLearn</a>

                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                        <!-- simple SVG toggler for consistent look on mobile -->
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" role="img">
                            <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>

                    <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                        <!-- mobile panel header is injected inside collapse so it slides with the panel -->
                        <div class="mobile-panel-header d-sm-none">
                            <div class="mobile-title">CampusLearn</div>
                            <!-- close toggles the same collapse target -->
                            <button class="btn-close" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-label="Close"></button>
                        </div>

                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Dashboard" asp-action="Index">Dashboard</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Modules" asp-action="Index">Modules</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="AIChat" asp-action="Chat">AI Chat</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Forum" asp-action="Index">Forums</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Profile" asp-action="Index">Profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Announcements" asp-action="Index">Announcements</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Grades" asp-action="Index">Grades</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="Chat" asp-action="Index">Messages</a>
                            </li>
                        </ul>
                    </div>

                    <!-- backdrop must come immediately after the collapse element so the adjacent selector can show it -->
                    <div class="mobile-backdrop d-sm-none" aria-hidden="true" data-bs-toggle="collapse" data-bs-target=".navbar-collapse"></div>
                </div>
            </nav>
        </header>
    }
    @{
        var controller = ViewContext.RouteData.Values["controller"]?.ToString();
        bool showSidebar = !string.Equals(controller, "LogIn", StringComparison.OrdinalIgnoreCase);
    }

    <div class="container-fluid">
        <div class="row">
            @if (showSidebar)
            {
                <aside class="col-12 col-md-3 col-lg-2 p-0">
                    @await Html.PartialAsync("_Sidebar")
                </aside>
                <main role="main" class="col-12 col-md-9 col-lg-10 pb-3">
                    @RenderBody()
                </main>
            }
            else
            {
                <main role="main" class="col-12 pb-3">
                    @RenderBody()
                </main>
            }
        </div>
    </div>
    @await Html.PartialAsync("_ChatPopup", new CampusLearn.Models.MessageView {
    Messages = new List<CampusLearn.Models.Message>
    {
    new CampusLearn.Models.Message {
    SenderName = "Teacher",
    Content = "Welcome to CampusLearn!",
    Timestamp = DateTime.Now,
    IsUser = false
    }}})
    <button onclick="toggleChat()" class="chat-toggle-btn">💬 Chat</button>


    <!-- Floating Chat Bubble -->
    <div id="chatBubble"
         style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            border-radius: 50%; background-color: #007bff; color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;">
        💬
    </div>

    <!-- Chat Sidebar -->
    <div id="chatSidebar"
         style="position: fixed; top: 0; right: -400px; width: 400px; height: 100%;
            background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.3);
            transition: right 0.3s ease; z-index: 4000;">
        <div style="display: flex; justify-content: space-between; align-items: center;
                padding: 10px; background-color: #007bff; color: white;">
            <h5 class="m-0">AI Chat</h5>
            <button id="closeChat" style="background: none; border: none; color: white; font-size: 20px;">×</button>
        </div>
        <div style="height: calc(100% - 50px); overflow-y: auto; padding: 10px;">
            @Html.Partial("~/Views/AIChat/Chat.cshtml")
        </div>
    </div>


    <script>

        const chatBubble = document.getElementById("chatBubble");
        const chatSidebar = document.getElementById("chatSidebar");
        const closeChat = document.getElementById("closeChat");

        chatBubble.addEventListener("click", () => {
            chatSidebar.style.right = "0";
        });

        closeChat.addEventListener("click", () => {
            chatSidebar.style.right = "-400px";
        });

        function toggleChat() {
            const popup = document.getElementById('chatPopup');
            popup.classList.toggle('hidden');
        }
    </script>


    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2025 - CampusLearn - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
