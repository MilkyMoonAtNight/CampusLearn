@{
    ViewData["Title"] = "AI Chat Assistant";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">CampusLearn AI Assistant 🤖</h2>

    <div id="chatBox" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
        <!-- Messages appear here -->
    </div>

    <div class="input-group">
        <input type="text" id="userInput" class="form-control" placeholder="Ask the AI something..." />
        <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
</div>

@section Scripts {
    <script>
        const chatBox = document.getElementById("chatBox");
        const sendBtn = document.getElementById("sendBtn");
        const userInput = document.getElementById("userInput");

        sendBtn.addEventListener("click", sendMessage);
        userInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMessage();
        });

        async function sendMessage() {
            const question = userInput.value.trim();
            if (!question) return;

            appendMessage("user", question);
            userInput.value = "";

            appendMessage("ai", "Thinking... 🤔");

            try {
                const response = await fetch("/api/AIAssistant/ask", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ question })
                });

                if (!response.ok) {
                    const err = await response.text();
                    appendMessage("error", "Error: " + err);
                    return;
                }

                const data = await response.json();
                updateLastMessage("ai", data.answer);
            } catch (err) {
                updateLastMessage("ai", "Error: " + err.message);
            }
        }

        function appendMessage(sender, text) {
            const div = document.createElement("div");
            div.classList.add("mb-2", "p-2", "rounded");

            if (sender === "user") {
                div.classList.add("bg-primary", "text-white", "text-end");
                div.textContent = "You: " + text;
            } else if (sender === "ai") {
                div.classList.add("bg-light");
                div.textContent = "AI: " + text;
            } else {
                div.classList.add("bg-danger", "text-white");
                div.textContent = text;
            }

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateLastMessage(sender, newText) {
            const messages = chatBox.querySelectorAll(".bg-light, .bg-primary, .bg-danger");
            const last = messages[messages.length - 1];
            if (last && last.textContent.startsWith("AI:")) {
                last.textContent = "AI: " + newText;
            }
        }
    </script>
}
